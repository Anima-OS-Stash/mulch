#cloud-config
#password: test
#chpasswd: {expire: False}
#ssh_pwauth: True

# to speed up things during dev, comment this:
# cost: Debian = 10s
package_upgrade: true

# Not really need, since the domain stops when ready and we've no way to
# "variabilize" the gateway yet.
#phone_home:
#  url: http://192.168.122.1/cloud-init.php


users:
  - name: mulch
    gecos: Mulch
    #groups: users
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    ssh_authorized_keys:
    - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCyJP5W0uB1M2AGSLesePNnBmPjUzu5ruJ1AswAWfghBwvqeJUOfj1lY1P/fqKxnS/K/KBrVu3f/QwvidB2JAWlRgux9iTY+PdJIbiNxKqJhCOrpJX+CrmhOrr4d+XK10VvtLDie7ArTapkOYUHmG5tB0/Iv9lYSvnee+cNK7HIem3UL3WilOxQ+UzR98jwsm1J6BDOsh0FcpLBkFYM8tF3/f/4F0oJ0OSVyUmUdlfHpuccQf4f4mZnHpltZdjc4/C6Auxf/uJcS3mW/Qz9F1I/0LLaHjQnp76zDmLfOdaQCBNthF7RlOXr9dAam91m41oz8jUQZU2Ydg7VtlRrZj8bAJtqxvq/9XLluvU7qYgFAXWoX25NV/X1gbmDv30KmNJ35EqUz/0nNdQp2a6bF+Hc1gnAKj4Jn8e0kVLoNV5XJoIQcJ8PY9FNG7YNTQpp3gqMNOQGLZnVwbE+DCC9+Psl9XIXWscwXNeIpi30IdnVMWYmabZgoXpLVl5+eTzVCy+e8kGuPadBh5o2TPj6sTzGmdPE2BymHPDJpxcgoAnLmtNp+jdGDJgcNrLY9zBjMmqfpCX8Y66qamESys79aKhbGSp6w+29U9sD37kkEMC5NydfCAmpclAJUOIX/Ya6DYqEEqO39l2v2qRj+LdS47abuk+lfThCiLhAlVH1JnE9SQ== test.xfennec@JulienDev

packages:
  - curl

write_files:
  - content: |
      [Unit]
      Description=Phone home on boot
      After=network.target

      [Service]
      RemainAfterExit=yes
      ExecStart=/usr/local/bin/phone_home
      User=root

      [Install]
      WantedBy=multi-user.target
    owner: root:root
    path: /etc/systemd/system/phone_home.service

  - content: |
      #!/bin/bash
      gw=$(ip -4 route list 0/0 | cut -d ' ' -f 3)
      id=$(cat /var/lib/cloud/data/instance-id)
      #uuid=$(dmidecode -s system-uuid)
      /usr/bin/curl -d "instance_id=$id" -X POST http://$gw:8585/phone
    owner: root:root
    permissions: '0755'
    path: /usr/local/bin/phone_home

runcmd:
  - [ systemctl, enable, phone_home ]

#locale:
timezone: Europe/Paris
ntp:
  enabled: true

power_state:
  mode: poweroff
  message: Cloud-init first boot finished, rebooting.
